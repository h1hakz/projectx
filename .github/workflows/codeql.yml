name: CodeQL

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write

jobs:
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v2
        with:
          upload: false
          output: results

      - name: Filter CodeQL results
        id: filter
        run: |
          jq '.runs[].results |= map(select((.ruleId != "py/sql-injection") and ((try (.properties["security-severity"] | tonumber) catch 0) >= 9.0)))' results/*.sarif > filtered.sarif
          results_count=$(jq '[.runs[].results | length] | max' filtered.sarif)
          echo "hasResults=$([ \"$results_count\" -gt 0 ] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Upload SARIF if results exist
        if: steps.filter.outputs.hasResults == 'true'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: filtered.sarif
