name: Trivy PR Scan and Block

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Check if Dockerfile exists in repo root
      - name: Check for Dockerfile
        id: check_dockerfile
        run: |
          if [ -f ./Dockerfile ]; then
            echo "found=true" >> $GITHUB_ENV
          else
            echo "found=false" >> $GITHUB_ENV
          fi

      # 3Ô∏è‚É£ Build Docker image
      - name: Build Docker image
        if: env.found == 'true'
        run: |
          docker build -t my-app:${{ github.sha }} .

      # 4Ô∏è‚É£ Run Trivy scan on the image
      - name: Run Trivy vulnerability scanner
        if: env.found == 'true'
        uses: aquasecurity/trivy-action@v0.28.0
        id: trivy_scan
        with:
          image-ref: 'my-app:${{ github.sha }}'
          format: 'template'
          template: '@/contrib/sarif.tpl'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '1'  # üî¥ Fail workflow if CRITICAL/HIGH vulns found

      # 5Ô∏è‚É£ Upload SARIF to Security tab
      - name: Upload Trivy SARIF results
        if: env.found == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      # 6Ô∏è‚É£ Post human-readable results as a PR comment
      - name: Post Trivy results as PR comment
        if: env.found == 'true'
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: trivy-results.sarif
          header: "üîí Trivy Scan Results"
